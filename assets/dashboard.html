<!DOCTYPE html>
<html lang="pt-BR" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <title>Proxy Manager | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Anima√ß√£o suave para novos itens */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="h-full text-sm text-slate-800">

    <div id="loginScreen" class="min-h-full flex items-center justify-center bg-slate-100">
        <form class="bg-white p-8 rounded-xl shadow-lg w-96 space-y-4" onsubmit="handleLogin(event)">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800">Proxy Manager</h2>
                <p class="text-xs text-slate-500 mt-1">Acesso Administrativo Seguro</p>
            </div>
            <input id="adminToken" type="password" placeholder="Token de Admin" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-medium transition-colors shadow-sm">Entrar no Painel</button>
        </form>
    </div>

    <div id="app" class="hidden min-h-full flex flex-col">
        <nav class="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-2 text-blue-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        <h1 class="font-bold text-lg tracking-tight text-slate-800">Proxy Manager <span class="text-xs font-normal text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded border ml-1">Enterprise</span></h1>
                    </div>
                    
                    <div class="flex gap-1 bg-slate-100 p-1 rounded-lg">
                        <button onclick="switchTab('monitor')" id="tab-monitor" class="px-4 py-1.5 rounded-md text-xs font-medium bg-white shadow text-blue-700 transition-all flex items-center gap-2">
                            <span>üì° Monitor</span>
                        </button>
                        <button onclick="switchTab('admin')" id="tab-admin" class="px-4 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:text-slate-700 transition-all flex items-center gap-2">
                            <span>‚öôÔ∏è Grupos</span>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg px-2 py-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Contexto:</label>
                        <select id="globalGroupSelect" onchange="changeGlobalFilter()" class="text-xs bg-transparent font-medium text-slate-700 outline-none cursor-pointer">
                            <option value="all">Todos os Grupos</option>
                        </select>
                    </div>
                    <div class="h-6 w-px bg-slate-200"></div>
                    <button onclick="logout()" class="text-xs text-slate-500 font-medium hover:text-red-600 transition-colors flex items-center gap-1">
                        SAIR
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-8 px-4 flex-1 w-full">
            
            <div id="view-monitor" class="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
                
                <div class="lg:col-span-2 space-y-6">
                    
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-5 py-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="flex h-2.5 w-2.5 rounded-full bg-green-500 animate-pulse"></span>
                                <h3 class="font-semibold text-slate-700">Conex√µes Ativas</h3>
                            </div>
                            <span id="totalCount" class="text-xs bg-slate-200 text-slate-600 px-2.5 py-0.5 rounded-full font-bold">0</span>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            <table class="w-full text-left">
                                <thead class="text-xs text-slate-400 bg-slate-50/50 uppercase font-medium border-b border-slate-100">
                                    <tr>
                                        <th class="px-5 py-3 w-1/3">ID do Cliente</th>
                                        <th class="px-5 py-3">Grupo</th>
                                        <th class="px-5 py-3">IP Origem</th>
                                        <th class="px-5 py-3 text-right">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="proxyList" class="divide-y divide-slate-100 text-xs"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col h-80">
                            <div class="px-5 py-3 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700 flex justify-between items-center">
                                <span>üîë Tokens de Instala√ß√£o</span>
                                <span class="text-[10px] text-slate-400 font-normal">1 por grupo</span>
                            </div>
                            <div class="overflow-y-auto flex-1">
                                <table class="w-full text-left"><tbody id="tokenList" class="divide-y divide-slate-100 text-xs"></tbody></table>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col h-80">
                            <div class="px-5 py-3 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700">
                                üë§ Usu√°rios de Autentica√ß√£o
                            </div>
                            <div class="overflow-y-auto flex-1">
                                <table class="w-full text-left">
                                    <thead class="text-xs bg-slate-50/50 text-slate-400 sticky top-0">
                                        <tr>
                                            <th class="px-5 py-2">Username</th>
                                            <th class="px-5 py-2">Grupo</th>
                                            <th class="px-5 py-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="userList" class="divide-y divide-slate-100 text-xs"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="space-y-6">
                    
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-2 mb-3 text-slate-800">
                            <div class="p-1.5 bg-yellow-100 text-yellow-700 rounded-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>
                            </div>
                            <h3 class="font-semibold">Gerar Token de Grupo</h3>
                        </div>
                        <p class="text-xs text-slate-500 mb-4 bg-slate-50 p-2 rounded border border-slate-100">
                            Gera um novo token para configurar o <b>Client Proxy</b>. O token antigo do grupo ser√° invalidado.
                        </p>
                        <form onsubmit="createToken(event)" class="space-y-3">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Nome do Grupo</label>
                                <input id="newTokenGroup" placeholder="ex: financeiro" class="w-full text-xs p-2.5 border border-slate-300 rounded focus:border-blue-500 outline-none" required>
                            </div>
                            <button class="w-full bg-slate-800 text-white py-2.5 rounded text-xs font-semibold hover:bg-slate-900 transition-colors">
                                Gerar & Copiar Token
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-2 mb-3 text-slate-800">
                            <div class="p-1.5 bg-blue-100 text-blue-700 rounded-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                            </div>
                            <h3 class="font-semibold">Criar/Alterar Usu√°rio</h3>
                        </div>
                        <p class="text-xs text-slate-500 mb-4 bg-blue-50 p-2 rounded border border-blue-100 text-blue-800">
                            Para alterar a senha de um usu√°rio, basta cri√°-lo novamente com o mesmo nome. A senha ser√° criptografada.
                        </p>
                        <form onsubmit="createUser(event)" class="space-y-3">
                            <input id="newUser" placeholder="Username" class="w-full text-xs p-2.5 border border-slate-300 rounded focus:border-blue-500 outline-none" required>
                            <input id="newPass" type="password" placeholder="Nova Senha" class="w-full text-xs p-2.5 border border-slate-300 rounded focus:border-blue-500 outline-none" required>
                            <div class="grid grid-cols-2 gap-2">
                                <input id="newUserGroup" placeholder="Grupo" class="w-full text-xs p-2.5 border border-slate-300 rounded focus:border-blue-500 outline-none" required>
                                <input id="newIP" value="*" placeholder="IP (Opcional)" class="w-full text-xs p-2.5 border border-slate-300 rounded focus:border-blue-500 outline-none" title="Deixe * para qualquer IP">
                            </div>
                            <button class="w-full bg-blue-600 text-white py-2.5 rounded text-xs font-semibold hover:bg-blue-700 transition-colors">Salvar Usu√°rio</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="view-admin" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-5 py-4 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700 flex justify-between items-center">
                            <span>Gest√£o de Grupos</span>
                        </div>
                        <table class="w-full text-left">
                            <thead class="text-xs text-slate-400 bg-slate-50 uppercase font-medium">
                                <tr>
                                    <th class="px-5 py-3">Nome do Grupo</th>
                                    <th class="px-5 py-3">Status</th>
                                    <th class="px-5 py-3 text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="groupList" class="divide-y divide-slate-100 text-sm"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm sticky top-24">
                        <h3 class="font-semibold mb-3">Criar Novo Grupo</h3>
                        <form onsubmit="createGroup(event)" class="space-y-3">
                            <input id="newGroupName" placeholder="Nome do Grupo (ex: marketing)" class="w-full text-xs p-2.5 border border-slate-300 rounded focus:border-green-500 outline-none" required>
                            <button class="w-full bg-green-600 text-white py-2.5 rounded text-xs font-semibold hover:bg-green-700 transition-colors">Adicionar Grupo</button>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>

<script>
    let authToken = localStorage.getItem('token');
    let currentFilter = 'all';

    async function api(url, method = 'GET', body = null) {
        const opts = { headers: { 'Authorization': 'Bearer ' + authToken } };
        if (method !== 'GET') {
            opts.method = method;
            if (body) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(body);
            }
        } else {
            const separator = url.includes('?') ? '&' : '?';
            url = `${url}${separator}_t=${new Date().getTime()}`;
        }
        
        try {
            const res = await fetch(url, opts);
            if (res.status === 401) { logout(); return null; }
            if (!res.ok) { console.error(`Erro API [${url}]:`, res.status); return null; }
            return res;
        } catch (error) {
            console.error("Falha na requisi√ß√£o:", error);
            return null;
        }
    }

    // --- Actions ---
    
    async function createToken(e) {
        e.preventDefault();
        const g = document.getElementById('newTokenGroup').value;
        const res = await api('/proxy-tokens', 'POST', {Group:g});
        if(res && res.ok) {
            const data = await res.json();
            navigator.clipboard.writeText(data.token);
            prompt(`Token gerado para ${g}!\n\nFoi copiado para a √°rea de transfer√™ncia.\nSalve-o agora, ele n√£o ser√° exibido novamente.`, data.token);
            refreshData();
        }
    }

    async function refreshData() {
        if (document.getElementById('view-monitor').classList.contains('hidden')) return;

        try {
            // Status
            const resStatus = await api(`/status?group=${currentFilter}`);
            if (resStatus) {
                const statusData = await resStatus.json();
                let htmlProxy = '', total = 0;
                for (const [grp, clients] of Object.entries(statusData)) {
                    clients.forEach(c => {
                        total++;
                        htmlProxy += `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-5 py-3 font-mono text-slate-600 font-medium">${c.id}</td>
                            <td class="px-5 py-3"><span class="px-2 py-1 rounded bg-slate-100 border border-slate-200 text-xs text-slate-500 font-medium">${grp}</span></td>
                            <td class="px-5 py-3 text-slate-500 font-mono text-xs">${c.addr}</td>
                            <td class="px-5 py-3 text-right text-green-600 font-medium flex justify-end items-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Online
                            </td>
                        </tr>`;
                    });
                }
                document.getElementById('proxyList').innerHTML = htmlProxy || '<tr><td colspan="4" class="p-8 text-center text-slate-400 italic">Nenhuma conex√£o ativa no momento.</td></tr>';
                document.getElementById('totalCount').innerText = total;
            }

            // Tokens
            const resTokens = await api(`/proxy-tokens?group=${currentFilter}`);
            if (resTokens) {
                const tokens = await resTokens.json();
                document.getElementById('tokenList').innerHTML = Object.entries(tokens).map(([grp, t]) => 
                    `<tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-5 py-3">
                            <div class="font-mono text-xs text-slate-600 bg-slate-100 p-1 rounded border break-all cursor-pointer hover:bg-white" onclick="navigator.clipboard.writeText('${t}')" title="Clique para copiar">
                                ${t}
                            </div>
                        </td>
                        <td class="px-5 py-3 text-slate-500 text-xs">${grp}</td>
                        <td class="px-5 py-3 text-right"><button onclick="delToken('${t}')" class="text-slate-300 hover:text-red-500 transition-colors">√ó</button></td>
                    </tr>`
                ).join('') || '<tr><td colspan="3" class="p-4 text-center text-slate-400 text-xs">Sem tokens ativos</td></tr>';
            }

            // Users
            const resUsers = await api(`/users?group=${currentFilter}`);
            if (resUsers) {
                const users = await resUsers.json();
                document.getElementById('userList').innerHTML = users.map(u => 
                    `<tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-5 py-3 font-medium text-slate-700">
                            <div class="flex items-center gap-2">
                                <span class="text-blue-600 font-bold">${u.username}</span>
                                <span class="text-[10px] bg-green-50 text-green-600 border border-green-100 px-1.5 rounded" title="Senha criptografada com BCrypt">Seguro</span>
                            </div>
                        </td>
                        <td class="px-5 py-3 text-slate-500">${u.group}</td>
                        <td class="px-5 py-3 text-right"><button onclick="delUser('${u.username}')" class="text-slate-300 hover:text-red-500 transition-colors">√ó</button></td>
                    </tr>`
                ).join('') || '<tr><td colspan="3" class="p-4 text-center text-slate-400 text-xs">Nenhum usu√°rio criado</td></tr>';
            }

        } catch (e) {
            console.error("Erro ao atualizar dados", e);
        }
    }

    async function handleLogin(e) { e.preventDefault(); const t = document.getElementById('adminToken').value; const res = await fetch('/status', { headers: { 'Authorization': 'Bearer ' + t } }); if (res.ok) { authToken = t; localStorage.setItem('token', t); initApp(); } else alert('Token inv√°lido'); }
    function checkAuth() { if (authToken) initApp(); }
    function logout() { localStorage.removeItem('token'); location.reload(); }

    // --- CORRE√á√ÉO DO LOOP AQUI ---
    function initApp() { 
        document.getElementById('loginScreen').classList.add('hidden'); 
        document.getElementById('app').classList.remove('hidden'); 
        loadGroups(); 
        
        // Inicia o loop recursivo seguro
        dataLoop(); 
    }

    // Loop Recursivo (Evita encavalamento de requisi√ß√µes)
    async function dataLoop() {
        await refreshData();
        // S√≥ agenda o pr√≥ximo se o anterior terminou
        setTimeout(dataLoop, 3000);
    }
    // -----------------------------

    function switchTab(tab) { document.getElementById('view-monitor').classList.add('hidden'); document.getElementById('view-admin').classList.add('hidden'); document.getElementById('tab-monitor').classList.replace('bg-white', 'text-slate-500'); document.getElementById('tab-monitor').classList.remove('shadow', 'text-blue-700'); document.getElementById('tab-admin').classList.replace('bg-white', 'text-slate-500'); document.getElementById('tab-admin').classList.remove('shadow', 'text-blue-700'); document.getElementById('view-' + tab).classList.remove('hidden'); const activeBtn = document.getElementById('tab-' + tab); activeBtn.classList.add('bg-white', 'shadow', 'text-blue-700'); activeBtn.classList.remove('text-slate-500'); if (tab === 'admin') loadGroupsList(); }
    function changeGlobalFilter() { currentFilter = document.getElementById('globalGroupSelect').value; refreshData(); if (currentFilter !== 'all') { document.getElementById('newTokenGroup').value = currentFilter; document.getElementById('newUserGroup').value = currentFilter; } }
    async function loadGroups() { const res = await api('/groups'); if(res) { const groups = await res.json(); const sel = document.getElementById('globalGroupSelect'); const oldVal = sel.value; sel.innerHTML = '<option value="all">Todos os Grupos</option>'; groups.forEach(g => { sel.innerHTML += `<option value="${g}">${g}</option>`; }); sel.value = oldVal; } }
    async function loadGroupsList() { const res = await api('/groups'); if(res) { const groups = await res.json(); document.getElementById('groupList').innerHTML = groups.map(g => `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="px-5 py-3 font-medium text-slate-800">${g}</td><td class="px-5 py-3"><span class="px-2 py-1 rounded text-xs bg-green-100 text-green-700">Ativo</span></td><td class="px-5 py-3 text-right space-x-2"><button onclick="delGroup('${g}')" class="text-red-500 hover:underline text-xs">Excluir</button></td></tr>`).join(''); } }
    
    async function createUser(e) { e.preventDefault(); const u = document.getElementById('newUser').value; const p = document.getElementById('newPass').value; const g = document.getElementById('newUserGroup').value; const i = document.getElementById('newIP').value; if(await api('/users', 'POST', {Username:u, AccessKey:p, Group:g, IP:i})) { document.getElementById('newUser').value = ''; document.getElementById('newPass').value = ''; refreshData(); alert('Usu√°rio salvo com sucesso!'); } }
    async function createGroup(e) { e.preventDefault(); const n = document.getElementById('newGroupName').value; if(await api('/groups', 'POST', {Name:n})) { document.getElementById('newGroupName').value = ''; loadGroupsList(); loadGroups(); } }
    async function delToken(t) { if(confirm('Apagar token?')) { await api(`/proxy-tokens?token=${t}`, 'DELETE'); refreshData(); } }
    async function delUser(u) { if(confirm('Apagar usu√°rio?')) { await api(`/users?username=${u}`, 'DELETE'); refreshData(); } }
    async function delGroup(n) { if(confirm('Tem certeza? Isso apagar√° tokens e usu√°rios do grupo.')) { await api(`/groups?name=${n}`, 'DELETE'); await loadGroupsList(); await loadGroups(); if(currentFilter === n) { document.getElementById('globalGroupSelect').value='all'; changeGlobalFilter(); } } }

    checkAuth();
</script>
</body>
</html>