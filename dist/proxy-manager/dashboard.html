<!DOCTYPE html>
<html lang="pt-BR" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <title>Proxy Manager | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="h-full text-sm text-slate-800">

    <div id="loginScreen" class="min-h-full flex items-center justify-center bg-slate-100">
        <form class="bg-white p-8 rounded-xl shadow-lg w-96 space-y-4" onsubmit="handleLogin(event)">
            <h2 class="text-xl font-bold text-center mb-4">Acesso Restrito</h2>
            <input id="adminToken" type="password" placeholder="Token Mestre" class="w-full border p-2 rounded" required>
            <button class="w-full bg-blue-600 text-white py-2 rounded font-medium">Entrar</button>
        </form>
    </div>

    <div id="app" class="hidden min-h-full">
        <nav class="bg-white border-b border-slate-200 sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-6">
                    <h1 class="font-bold text-lg text-slate-800">Proxy Manager</h1>
                    <div class="flex gap-1 bg-slate-100 p-1 rounded-lg">
                        <button onclick="switchTab('monitor')" id="tab-monitor" class="px-4 py-1.5 rounded-md text-xs font-medium bg-white shadow text-blue-700 transition-all">Monitor</button>
                        <button onclick="switchTab('admin')" id="tab-admin" class="px-4 py-1.5 rounded-md text-xs font-medium text-slate-500 hover:text-slate-700 transition-all">Gest√£o de Grupos</button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Filtrar:</label>
                        <select id="globalGroupSelect" onchange="changeGlobalFilter()" class="text-xs border border-slate-300 rounded px-2 py-1.5 bg-slate-50 outline-none focus:border-blue-500">
                            <option value="all">Todos os Grupos</option>
                        </select>
                    </div>
                    <button onclick="logout()" class="text-xs text-red-500 font-medium hover:underline">SAIR</button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-8 px-4">
            
            <div id="view-monitor" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-5 py-3 bg-slate-50 border-b border-slate-100 flex justify-between">
                            <h3 class="font-semibold text-slate-700">üì° Conex√µes Ativas</h3>
                            <span id="totalCount" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">0</span>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            <table class="w-full text-left">
                                <thead class="text-xs text-slate-400 bg-slate-50 uppercase font-medium">
                                    <tr><th class="px-5 py-2">ID</th><th class="px-5 py-2">Grupo</th><th class="px-5 py-2">IP</th><th class="px-5 py-2">Status</th></tr>
                                </thead>
                                <tbody id="proxyList" class="divide-y divide-slate-100 text-xs"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="px-5 py-3 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700">üîë Tokens (1 por grupo)</div>
                            <div class="max-h-60 overflow-y-auto">
                                <table class="w-full text-left"><tbody id="tokenList" class="divide-y divide-slate-100 text-xs"></tbody></table>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="px-5 py-3 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700">üë§ Usu√°rios API</div>
                            <div class="max-h-60 overflow-y-auto">
                                <table class="w-full text-left">
                                    <thead class="text-xs bg-slate-50 text-slate-400">
                                        <tr><th class="px-5 py-2">Credenciais</th><th class="px-5 py-2">Grupo</th><th class="px-5 py-2"></th></tr>
                                    </thead>
                                    <tbody id="userList" class="divide-y divide-slate-100 text-xs"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-semibold mb-2">Gerar Token de Grupo</h3>
                        <p class="text-xs text-slate-500 mb-3">Isso invalidar√° o token anterior deste grupo.</p>
                        <form onsubmit="createToken(event)" class="space-y-3">
                            <input id="newTokenGroup" placeholder="Grupo (ex: financeiro)" class="w-full text-xs p-2 border rounded" required>
                            <button class="w-full bg-blue-600 text-white py-2 rounded text-xs font-medium hover:bg-blue-700">
                                Gerar & Substituir Token
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-semibold mb-3">Novo Usu√°rio</h3>
                        <form onsubmit="createUser(event)" class="space-y-3">
                            <input id="newUser" placeholder="Username" class="w-full text-xs p-2 border rounded" required>
                            <input id="newPass" type="password" placeholder="Senha" class="w-full text-xs p-2 border rounded" required>
                            <div class="grid grid-cols-2 gap-2">
                                <input id="newUserGroup" placeholder="Grupo" class="w-full text-xs p-2 border rounded" required>
                                <input id="newIP" value="*" class="w-full text-xs p-2 border rounded">
                            </div>
                            <button class="w-full bg-blue-600 text-white py-2 rounded text-xs font-medium hover:bg-blue-700">Criar Usu√°rio</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="view-admin" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="px-5 py-3 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700">Gest√£o de Grupos</div>
                        <table class="w-full text-left">
                            <thead class="text-xs text-slate-400 bg-slate-50 uppercase font-medium">
                                <tr><th class="px-5 py-2">Nome do Grupo</th><th class="px-5 py-2">Status</th><th class="px-5 py-2 text-right">A√ß√µes</th></tr>
                            </thead>
                            <tbody id="groupList" class="divide-y divide-slate-100 text-sm"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-semibold mb-3">Criar Novo Grupo</h3>
                        <form onsubmit="createGroup(event)" class="space-y-3">
                            <input id="newGroupName" placeholder="Nome do Grupo (ex: marketing)" class="w-full text-xs p-2 border rounded" required>
                            <button class="w-full bg-green-600 text-white py-2 rounded text-xs font-medium hover:bg-green-700">Adicionar Grupo</button>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>

<script>
    let authToken = localStorage.getItem('token');
    let currentFilter = 'all';

    async function api(url, method = 'GET', body = null) {
        const opts = { headers: { 'Authorization': 'Bearer ' + authToken } };
        if (method !== 'GET') {
            opts.method = method;
            if (body) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(body);
            }
        } else {
            const separator = url.includes('?') ? '&' : '?';
            url = `${url}${separator}_t=${new Date().getTime()}`;
        }
        const res = await fetch(url, opts);
        if (res.status === 401) logout();
        return res;
    }

    // --- Actions ---
    
    // Novo CreateToken: N√£o envia token, s√≥ grupo. Mostra alerta com o token gerado.
    async function createToken(e) {
        e.preventDefault();
        const g = document.getElementById('newTokenGroup').value;
        const res = await api('/proxy-tokens', 'POST', {Group:g});
        if(res.ok) {
            const data = await res.json();
            prompt("Token gerado! Copie e salve, ele n√£o ser√° mostrado novamente assim.", data.token);
            refreshData();
        }
    }

    // Refresh Data: Atualizado para mostrar senha e formatar tabela
    async function refreshData() {
        if (document.getElementById('view-monitor').classList.contains('hidden')) return;

        // Status
        const statusData = await (await api(`/status?group=${currentFilter}`)).json();
        let htmlProxy = '', total = 0;
        for (const [grp, clients] of Object.entries(statusData)) {
            clients.forEach(c => {
                total++;
                htmlProxy += `<tr class="hover:bg-slate-50"><td class="px-5 py-2 font-mono text-slate-600">${c.id}</td><td class="px-5 py-2"><span class="px-2 py-0.5 rounded bg-slate-100 border text-slate-500">${grp}</span></td><td class="px-5 py-2 text-slate-400 font-mono">${c.addr}</td><td class="px-5 py-2 text-green-600">Online</td></tr>`;
            });
        }
        document.getElementById('proxyList').innerHTML = htmlProxy || '<tr><td colspan="4" class="p-4 text-center text-slate-400">Vazio</td></tr>';
        document.getElementById('totalCount').innerText = total;

        // Tokens
        const tokens = await (await api(`/proxy-tokens?group=${currentFilter}`)).json();
        document.getElementById('tokenList').innerHTML = tokens.map(t => 
            `<tr class="hover:bg-slate-50"><td class="px-5 py-2 font-mono text-slate-600 break-all">${t.token}</td><td class="px-5 py-2 text-slate-400">${t.group}</td><td class="px-5 py-2 text-right"><button onclick="delToken('${t.token}')" class="text-red-400 hover:text-red-600">√ó</button></td></tr>`
        ).join('') || '<tr><td colspan="3" class="p-4 text-center text-slate-400">Vazio</td></tr>';

        // Users (Agora mostrando credenciais)
        const users = await (await api(`/users?group=${currentFilter}`)).json();
        document.getElementById('userList').innerHTML = users.map(u => 
            `<tr class="hover:bg-slate-50">
                <td class="px-5 py-2 font-medium text-slate-700">
                    <span class="text-blue-600">${u.username}</span> <span class="text-slate-400 mx-1">:</span> <span class="font-mono text-slate-600 bg-slate-100 px-1 rounded">${u.access_key}</span>
                </td>
                <td class="px-5 py-2 text-slate-400">${u.group}</td>
                <td class="px-5 py-2 text-right"><button onclick="delUser('${u.username}')" class="text-red-400 hover:text-red-600">√ó</button></td>
            </tr>`
        ).join('') || '<tr><td colspan="3" class="p-4 text-center text-slate-400">Vazio</td></tr>';
    }

    // Resto das fun√ß√µes (Login, LoadGroups, CreateGroup, Delete...) mantenha igual ao anterior
    async function handleLogin(e) { e.preventDefault(); const t = document.getElementById('adminToken').value; const res = await fetch('/status', { headers: { 'Authorization': 'Bearer ' + t } }); if (res.ok) { authToken = t; localStorage.setItem('token', t); initApp(); } else alert('Token inv√°lido'); }
    function checkAuth() { if (authToken) initApp(); }
    function logout() { localStorage.removeItem('token'); location.reload(); }
    function initApp() { document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); loadGroups(); refreshData(); setInterval(refreshData, 3000); }
    function switchTab(tab) { document.getElementById('view-monitor').classList.add('hidden'); document.getElementById('view-admin').classList.add('hidden'); document.getElementById('tab-monitor').classList.replace('bg-white', 'text-slate-500'); document.getElementById('tab-monitor').classList.remove('shadow', 'text-blue-700'); document.getElementById('tab-admin').classList.replace('bg-white', 'text-slate-500'); document.getElementById('tab-admin').classList.remove('shadow', 'text-blue-700'); document.getElementById('view-' + tab).classList.remove('hidden'); const activeBtn = document.getElementById('tab-' + tab); activeBtn.classList.add('bg-white', 'shadow', 'text-blue-700'); activeBtn.classList.remove('text-slate-500'); if (tab === 'admin') loadGroupsList(); }
    function changeGlobalFilter() { currentFilter = document.getElementById('globalGroupSelect').value; refreshData(); if (currentFilter !== 'all') { document.getElementById('newTokenGroup').value = currentFilter; document.getElementById('newUserGroup').value = currentFilter; } }
    async function loadGroups() { const res = await api('/groups'); const groups = await res.json(); const sel = document.getElementById('globalGroupSelect'); const oldVal = sel.value; sel.innerHTML = '<option value="all">Todos os Grupos</option>'; groups.forEach(g => { sel.innerHTML += `<option value="${g.name}">${g.name}</option>`; }); sel.value = oldVal; }
    async function loadGroupsList() { const groups = await (await api('/groups')).json(); document.getElementById('groupList').innerHTML = groups.map(g => `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="px-5 py-3 font-medium text-slate-800">${g.name}</td><td class="px-5 py-3"><span class="px-2 py-1 rounded text-xs ${g.status==='active'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${g.status}</span></td><td class="px-5 py-3 text-right space-x-2"><button onclick="toggleGroup('${g.name}', '${g.status}')" class="text-blue-500 hover:underline text-xs">${g.status==='active'?'Inativar':'Ativar'}</button><button onclick="delGroup('${g.name}')" class="text-red-500 hover:underline text-xs">Excluir</button></td></tr>`).join(''); }
    
    async function createUser(e) { e.preventDefault(); const u = document.getElementById('newUser').value; const p = document.getElementById('newPass').value; const g = document.getElementById('newUserGroup').value; const i = document.getElementById('newIP').value; if(await api('/users', 'POST', {Username:u, AccessKey:p, Group:g, IP:i})) { document.getElementById('newUser').value = ''; document.getElementById('newPass').value = ''; refreshData(); loadGroups(); } }
    async function createGroup(e) { e.preventDefault(); const n = document.getElementById('newGroupName').value; if(await api('/groups', 'POST', {Name:n})) { document.getElementById('newGroupName').value = ''; loadGroupsList(); loadGroups(); } }
    async function delToken(t) { if(confirm('Apagar token?')) { await api(`/proxy-tokens?token=${t}`, 'DELETE'); refreshData(); } }
    async function delUser(u) { if(confirm('Apagar usu√°rio?')) { await api(`/users?username=${u}`, 'DELETE'); refreshData(); } }
    async function delGroup(n) { if(confirm('Tem certeza? Isso apagar√° tokens e usu√°rios do grupo.')) { await api(`/groups?name=${n}`, 'DELETE'); await loadGroupsList(); await loadGroups(); if(currentFilter === n) { document.getElementById('globalGroupSelect').value='all'; changeGlobalFilter(); } } }
    async function toggleGroup(n, current) { await api('/groups', 'PUT', {Name:n, Status:current==='active'?'inactive':'active'}); loadGroupsList(); }

    checkAuth();
</script>
</body>
</html>